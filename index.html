<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Events — Discover Jamaica</title>
<meta name="description" content="Discover events in Jamaica." />
<style>
  :root{
    --bg:#0b1020; --card:#10172a; --muted:#9aa4b2; --text:#ecf2ff;
    --accent:#5ca0ff; --accent-2:#9bffd1; --ring: rgba(92,160,255,.45);
  }
  /* Base & overflow guard */
  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  html, body{ margin:0; overflow-x:hidden; }
  body{
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background: radial-gradient(1200px 600px at 80% -10%, #14203d 0%, #0b1020 60%), var(--bg);
    color:var(--text);
  }

  .container{ max-width:1100px; margin:0 auto; padding:24px 16px; }

  /* HEADER */
  header{
    display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; margin-bottom:6px;
  }
  .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
  .logo{ width:40px; height:40px; border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 6px 18px rgba(92,160,255,.35); }
  .title-wrap{ min-width:0; }
  .title-wrap h1{
    font-size:1.2rem; margin:0; letter-spacing:.3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .right-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  /* Buttons & Avatar */
  .avatar-btn{
    width:42px; height:42px; border-radius:50%; border:1px solid rgba(255,255,255,.14);
    background:#0f1527; overflow:hidden; display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  .avatar-img{ width:100%; height:100%; object-fit:cover; display:block; }
  .avatar-fallback{ font-weight:800; letter-spacing:.3px; color:#cfe3ff; }
  .hostBtn, .filterBtn{
    padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(135deg,var(--accent),#3b82f6); color:#fff; font-weight:700; cursor:pointer;
    box-shadow:0 8px 18px rgba(59,130,246,.35);
  }
  .hostBtn{ display:none; } /* shown only if verified host */
  .hostBtn:hover, .filterBtn:hover{ filter:brightness(1.05); }

  /* SEARCH (full-width, below header) */
  .search-wrap{ margin:10px 0 14px; }
  .search-wrap input{
    width:100%; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
    background:#0f1527; color:var(--text); outline:none; font-size:1rem;
  }
  .search-wrap input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring); }

  /* FILTER PANEL (hidden until opened) */
  .filters-panel{
    display:none; /* toggled with JS */
    margin-bottom:14px;
    background:rgba(16,23,42,.7); border:1px solid rgba(255,255,255,.06);
    backdrop-filter: blur(6px); padding:14px; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  .filters-grid{
    display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .filters-panel select,.filters-panel input,.filters-panel button{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0f1527; color:var(--text); outline:none; font-size:.95rem;
  }
  .filters-panel select:focus,.filters-panel input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring); }
  .filters-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
  .btn-secondary{ background:#0f1527; border:1px solid rgba(255,255,255,.16); color:var(--text); cursor:pointer; }
  .btn-secondary:hover{ border-color:var(--accent); }

  /* Inside-label for date inputs */
  .field{ position:relative; }
  .inside-label{
    pointer-events:none; position:absolute; left:14px; top:50%; transform:translateY(-50%);
    color:var(--muted); font-size:.92rem; opacity:.9;
  }
  .field input[type="date"]:focus + .inside-label,
  .field input[type="date"].has-value + .inside-label{ display:none; }

  .meta{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    margin:10px 2px 18px; color:var(--muted); font-size:.92rem; flex-wrap:wrap;
  }

  /* GRID */
  .grid{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; }
  @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 640px){ .grid{ grid-template-columns: minmax(0,1fr); } }

  /* CARDS */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border: 1px solid rgba(255,255,255,.06); border-radius:16px; overflow:hidden;
    box-shadow:0 12px 30px rgba(0,0,0,.35); display:flex; flex-direction:column; min-width:0;
  }
  .thumb{ position:relative; height:170px; overflow:hidden; background:#0f162e; }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .chip{
    position:absolute; left:10px; top:10px; padding:6px 10px; border-radius:999px;
    background:rgba(12, 215, 172, .15); color:#9bffd1; font-weight:700; font-size:.75rem; letter-spacing:.3px;
    border:1px solid rgba(155,255,209,.25); max-width:calc(100% - 20px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .content{ padding:14px 14px 12px; }
  .title{
    font-weight:800; margin:0 0 6px; font-size:1.05rem; letter-spacing:.2px;
    overflow-wrap:anywhere;
  }
  .muted{ color:var(--muted); font-size:.92rem; overflow-wrap:anywhere; }
  .row{ display:flex; align-items:center; gap:10px; margin-top:8px; flex-wrap:wrap; }
  .badge{
    padding:4px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
    background:#0f1527; color:#cdd7e6; font-size:.78rem; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .footer{
    display:flex; justify-content:space-between; align-items:center; gap:8px;
    padding:12px 14px; border-top:1px solid rgba(255,255,255,.06); flex-wrap:wrap;
  }
  .btn{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0f1527; color:var(--text); cursor:pointer; }
  .btn:hover{ border-color:var(--accent); }
  .empty{ border:1px dashed rgba(255,255,255,.14); border-radius:14px; padding:28px; text-align:center; color:var(--muted); margin-top:16px }

  /* DIALOGS */
  dialog{ border:none; border-radius:14px; padding:0; max-width:min(720px, calc(100vw - 32px)); width:100%; }
  .modal{ background:#0f1527; color:var(--text); border:1px solid rgba(255,255,255,.06); border-radius:14px; overflow:hidden; }
  .modal header{ padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.08); }
  .modal .body{ padding:16px 18px; }
  .modal footer{ padding:14px 18px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 640px){ .grid-2{ grid-template-columns:1fr; } }
  .modal input,.modal select,.modal textarea{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1120; color:var(--text);
  }
  .pill{ padding:6px 10px; border-radius:999px; background:#0b1120; border:1px solid rgba(255,255,255,.08); font-size:.8rem; }
  .linklike{ background:transparent; border:1px dashed rgba(255,255,255,.2); color:#cfe3ff; }
  .danger{ display:none; } /* removed Clear Profile button per request */
  .small{ font-size:.9rem; color:var(--muted); }
</style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title-wrap">
          <h1>Discover Events</h1>
        </div>
      </div>

      <!-- spacer -->
      <div></div>

      <!-- Right: Filters + Host (only when verified) + Avatar -->
      <div class="right-actions">
        <button id="filterToggle" class="filterBtn" title="Show filters">Filters</button>
        <button id="hostBtn" class="hostBtn" title="Host Dashboard">Host Dashboard</button>
        <button id="avatarBtn" class="avatar-btn" title="Your Profile">
          <span id="avatarFallback" class="avatar-fallback">U</span>
          <img id="avatarImg" class="avatar-img" alt="" style="display:none" />
        </button>
      </div>
    </header>

    <!-- SEARCH (full-width) -->
    <div class="search-wrap">
      <input id="qTop" type="text" placeholder="Search events (title, venue, description)..." />
    </div>

    <!-- FILTER PANEL (hidden until Filters clicked) -->
    <section id="filtersPanel" class="filters-panel" aria-hidden="true">
      <div class="filters-grid">
        <select id="location" aria-label="Location">
          <option value="" selected disabled>Location</option>
          <!-- options populated from data -->
        </select>

        <select id="category" aria-label="Category">
          <option value="" selected disabled>Category</option>
          <!-- options populated from data -->
        </select>

        <div class="field">
          <input id="start" type="date" aria-label="Start date" />
          <span class="inside-label">Start date</span>
        </div>
        <div class="field">
          <input id="end" type="date" aria-label="End date" />
          <span class="inside-label">End date</span>
        </div>
      </div>
      <div class="filters-actions">
        <button id="resetFilters" class="btn-secondary" type="button">Reset Filters</button>
        <button id="closeFilters" class="btn-secondary" type="button">Close</button>
      </div>
    </section>

    <div class="meta">
      <div id="count">0 events</div>
      <div id="activeFilters"></div>
    </div>

    <!-- EVENT GRID -->
    <section class="grid" id="grid"></section>
    <div id="empty" class="empty" style="display:none;">No events match your filters.</div>
  </div>

  <!-- PROFILE MODAL -->
  <dialog id="profileDialog">
    <form method="dialog" class="modal" id="profileForm">
      <header><strong>Your Profile</strong></header>
      <div class="body">
        <div class="grid-2">
          <div><label>Full Name <input id="pName" required placeholder="Jane Doe"></label></div>
          <div><label>Email <input id="pEmail" type="email" required placeholder="jane@example.com"></label></div>
          <div><label>Phone <input id="pPhone" placeholder="+1 (876) 555‑1234"></label></div>
          <div><label>City <input id="pCity" placeholder="Kingston"></label></div>
          <div><label>Profile Photo <input id="pPhoto" type="file" accept="image/*"></label></div>
          <div>
            <label>Are you a host?
              <select id="pIsHost">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Host section -->
        <div id="hostFields" style="margin-top:12px;display:none">
          <hr style="border-color:rgba(255,255,255,.08);border-style:solid;border-width:1px 0 0;margin:6px 0 16px">
          <div class="grid-2">
            <div><label>Organizer / Business Name <input id="hOrgName" placeholder="My Events JA"></label></div>
            <div><label>ID Type
              <select id="hIdType">
                <option value="">Select…</option>
                <option>Passport</option>
                <option>National ID</option>
                <option>Driver's License</option>
              </select></label>
            </div>
            <div><label>Name on ID (exact) <input id="hIdName" placeholder="Jane Doe"></label></div>
            <div><label>ID Image (front/main page) <input id="hIdImage" type="file" accept="image/*"></label></div>
          </div>
          <p class="small">We’ll verify locally that <strong>Name on ID</strong> exactly matches your profile <strong>Full Name</strong> and an <strong>ID image</strong> is uploaded. (For real KYC you’ll need a backend.)</p>
        </div>

        <div id="profileSummary" style="margin-top:10px"></div>
      </div>
      <footer>
        <!-- Cancel closes dialog without saving -->
        <button id="cancelProfile" type="button" class="btn linklike">Cancel</button>
        <button id="saveProfileBtn" class="btn">Save</button>
      </footer>
    </form>
  </dialog>

  <!-- HOST DASHBOARD (only for verified hosts) -->
  <dialog id="hostDialog">
    <form method="dialog" class="modal" id="postForm">
      <header><strong>Host Dashboard — Post Event</strong></header>
      <div class="body">
        <div class="grid-2">
          <div><label>Title <input id="fTitle" required placeholder="Event title"></label></div>
          <div><label>Category
            <select id="fCategory" required>
              <option value="">Select…</option>
              <option>Music</option><option>Food & Drink</option><option>Sports</option>
              <option>Business</option><option>Culture</option><option>Family</option><option>Nightlife</option>
            </select></label></div>
          <div><label>Location (City/Town) <input id="fLocation" required placeholder="Kingston"></label></div>
          <div><label>Venue <input id="fVenue" required placeholder="National Stadium"></label></div>
          <div><label>Start Date & Time <input id="fStart" type="datetime-local" required></label></div>
          <div><label>End Date & Time <input id="fEnd" type="datetime-local" required></label></div>
          <div><label>Ticket Price (JMD) <input id="fPrice" type="number" min="0" step="1" value="0" required></label></div>
          <div><label>Cover Image <input id="fCover" type="file" accept="image/*"></label></div>
          <div style="grid-column:1/-1"><label>Description <textarea id="fDesc" rows="4" placeholder="Describe your event"></textarea></label></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <span class="pill">Host verified (local)</span>
          <span class="pill">Saved in this browser</span>
        </div>
      </div>
      <footer>
        <button value="cancel" class="btn linklike">Close</button>
        <button id="saveEventBtn" class="btn">Save Event</button>
      </footer>
    </form>
  </dialog>

<script>
/* ===== Local DB (events) ===== */
const DB_KEY = 'events_v1';
const readDB = () => JSON.parse(localStorage.getItem(DB_KEY) || 'null') || [];
const writeDB = (list) => localStorage.setItem(DB_KEY, JSON.stringify(list));

/* ===== Local Profile ===== */
const PROFILE_KEY = 'profile_v1';
const readProfile = () => JSON.parse(localStorage.getItem(PROFILE_KEY) || 'null');
const writeProfile = (p) => localStorage.setItem(PROFILE_KEY, JSON.stringify(p));

/* ===== Utilities ===== */
const uid = () => Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,6);
const fmtMoney = (jmd) => `JMD ${Number(jmd||0).toLocaleString()}`;
const toLocalDate = (iso) => {
  const d = new Date(iso);
  const day = d.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
  const time = d.toLocaleTimeString(undefined, {hour:'numeric', minute:'2-digit'});
  return `${day} • ${time}`;
};
const fileToDataURL = (file) => new Promise((resolve,reject)=>{
  if(!file) return resolve('');
  const r = new FileReader();
  r.onload = () => resolve(r.result);
  r.onerror = reject;
  r.readAsDataURL(file);
});
const initialsOf = (name='') => name.trim().split(/\s+/).map(s=>s[0]?.toUpperCase()).slice(0,2).join('') || 'U';

/* ===== Elements & State ===== */
let state = { q:"", location:"", category:"", start:"", end:"" };

const els = {
  grid: document.getElementById('grid'),
  count: document.getElementById('count'),
  empty: document.getElementById('empty'),
  activeFilters: document.getElementById('activeFilters'),

  qTop: document.getElementById('qTop'),
  filterToggle: document.getElementById('filterToggle'),
  filtersPanel: document.getElementById('filtersPanel'),
  closeFilters: document.getElementById('closeFilters'),
  resetFilters: document.getElementById('resetFilters'),

  location: document.getElementById('location'),
  category: document.getElementById('category'),
  start: document.getElementById('start'),
  end: document.getElementById('end'),

  avatarBtn: document.getElementById('avatarBtn'),
  avatarImg: document.getElementById('avatarImg'),
  avatarFallback: document.getElementById('avatarFallback'),
  hostBtn: document.getElementById('hostBtn'),

  profileDialog: document.getElementById('profileDialog'),
  profileForm: document.getElementById('profileForm'),
  pName: document.getElementById('pName'),
  pEmail: document.getElementById('pEmail'),
  pPhone: document.getElementById('pPhone'),
  pCity: document.getElementById('pCity'),
  pPhoto: document.getElementById('pPhoto'),
  pIsHost: document.getElementById('pIsHost'),
  hostFields: document.getElementById('hostFields'),
  hOrgName: document.getElementById('hOrgName'),
  hIdType: document.getElementById('hIdType'),
  hIdName: document.getElementById('hIdName'),
  hIdImage: document.getElementById('hIdImage'),
  saveProfileBtn: document.getElementById('saveProfileBtn'),
  cancelProfile: document.getElementById('cancelProfile'),
  profileSummary: document.getElementById('profileSummary'),

  hostDialog: document.getElementById('hostDialog'),
  postForm: document.getElementById('postForm'),
  fTitle: document.getElementById('fTitle'),
  fCategory: document.getElementById('fCategory'),
  fLocation: document.getElementById('fLocation'),
  fVenue: document.getElementById('fVenue'),
  fStart: document.getElementById('fStart'),
  fEnd: document.getElementById('fEnd'),
  fPrice: document.getElementById('fPrice'),
  fCover: document.getElementById('fCover'),
  fDesc: document.getElementById('fDesc'),
  saveEventBtn: document.getElementById('saveEventBtn')
};

/* ===== Filters: build options from data ===== */
function refreshFilterOptions(list){
  // Location & category placeholders remain; we add unique options
  const locations = Array.from(new Set(list.map(e=>e.location).filter(Boolean))).sort();
  const categories = Array.from(new Set(list.map(e=>e.category).filter(Boolean))).sort();

  els.location.innerHTML = `<option value="" selected disabled>Location</option>` + locations.map(l=>`<option>${l}</option>`).join('');
  els.category.innerHTML = `<option value="" selected disabled>Category</option>` + categories.map(c=>`<option>${c}</option>`).join('');
}

/* ===== Render events (always show; narrow if filters set) ===== */
function applyFilters(){
  let results = readDB(); // all events by default

  const q = state.q.trim().toLowerCase();
  if (q){
    results = results.filter(e =>
      e.title.toLowerCase().includes(q) ||
      e.venue.toLowerCase().includes(q) ||
      (e.description||"").toLowerCase().includes(q)
    );
  }
  if (state.location){
    results = results.filter(e => e.location === state.location);
  }
  if (state.category){
    results = results.filter(e => e.category === state.category);
  }
  if (state.start){
    const s = new Date(state.start + "T00:00:00");
    results = results.filter(e => new Date(e.startsAt) >= s);
  }
  if (state.end){
    const eDate = new Date(state.end + "T23:59:59");
    results = results.filter(e => new Date(e.startsAt) <= eDate);
  }
  render(results);
}

function render(list){
  els.grid.innerHTML = '';
  refreshFilterOptions(readDB());

  if (!list.length){
    els.count.textContent = '0 events';
    els.empty.style.display = 'block';
    els.activeFilters.textContent = '';
    return;
  }
  els.empty.style.display = 'none';
  els.count.textContent = `${list.length} event${list.length>1?'s':''}`;

  const chips = [];
  if (state.q) chips.push(`Search: “${state.q}”`);
  if (state.location) chips.push(state.location);
  if (state.category) chips.push(state.category);
  if (state.start) chips.push(`From ${state.start}`);
  if (state.end) chips.push(`To ${state.end}`);
  els.activeFilters.textContent = chips.join(' • ');

  const frag = document.createDocumentFragment();
  list
    .sort((a,b)=> new Date(a.startsAt)-new Date(b.startsAt))
    .forEach(ev=>{
      const card = document.createElement('article');
      card.className = 'card';
      const cover = ev.cover || '';
      card.innerHTML = `
        <div class="thumb">${cover ? `<img src="${cover}" alt="${ev.title}">` : ''}<div class="chip">${ev.category||'Event'}</div></div>
        <div class="content">
          <h3 class="title">${ev.title}</h3>
          <div class="muted">${ev.venue||''}${ev.venue?', ':''}${ev.location||''}</div>
          <div class="row">
            <span class="badge">${toLocalDate(ev.startsAt)}</span>
            ${ev.endsAt ? `<span class="badge">Ends ${toLocalDate(ev.endsAt)}</span>`:''}
            <span class="badge">${fmtMoney(ev.priceJMD||0)}</span>
          </div>
          ${ev.description ? `<p class="muted" style="margin:10px 0 0">${ev.description}</p>`:''}
        </div>
        <div class="footer">
          <span class="muted">${new URL(location.href).origin}</span>
          <button class="btn" onclick="alert('Static demo. Connect checkout later.')">View / Buy</button>
        </div>
      `;
      frag.appendChild(card);
    });
  els.grid.appendChild(frag);
}

/* ===== Search & filter wiring ===== */
els.qTop.addEventListener('input', ()=>{ state.q = els.qTop.value; applyFilters(); });

['change','input'].forEach(evt=>{
  els.location.addEventListener(evt, ()=>{ state.location = els.location.value; applyFilters(); });
  els.category.addEventListener(evt, ()=>{ state.category = els.category.value; applyFilters(); });
  els.start.addEventListener(evt, ()=>{
    els.start.classList.toggle('has-value', !!els.start.value);
    state.start = els.start.value; applyFilters();
  });
  els.end.addEventListener(evt, ()=>{
    els.end.classList.toggle('has-value', !!els.end.value);
    state.end = els.end.value; applyFilters();
  });
});

/* Toggle filter panel */
els.filterToggle.addEventListener('click', ()=>{
  const open = els.filtersPanel.style.display === 'block';
  els.filtersPanel.style.display = open ? 'none' : 'block';
  els.filtersPanel.setAttribute('aria-hidden', open ? 'true' : 'false');
});
els.closeFilters.addEventListener('click', ()=>{
  els.filtersPanel.style.display = 'none';
  els.filtersPanel.setAttribute('aria-hidden', 'true');
});
els.resetFilters.addEventListener('click', ()=>{
  state = { q: els.qTop.value || "", location:"", category:"", start:"", end:"" };
  els.location.value = ""; els.category.value = "";
  els.start.value = ""; els.end.value = "";
  els.start.classList.remove('has-value'); els.end.classList.remove('has-value');
  applyFilters();
});

/* ===== Profile helpers ===== */
function setAvatarFromProfile(p){
  const img = els.avatarImg, fb = els.avatarFallback;
  if (p?.photo){
    img.src = p.photo; img.style.display='block'; fb.style.display='none';
  } else {
    img.style.display='none'; fb.style.display='inline-flex';
    fb.textContent = (p?.name ? initialsOf(p.name) : 'U');
  }
  els.hostBtn.style.display = (p?.isHost && p?.host?.verified) ? 'inline-block' : 'none';
}
function fillProfileForm(p){
  els.pName.value = p?.name || '';
  els.pEmail.value = p?.email || '';
  els.pPhone.value = p?.phone || '';
  els.pCity.value = p?.city || '';
  els.pIsHost.value = p?.isHost ? 'yes' : 'no';
  els.hostFields.style.display = p?.isHost ? 'block' : 'none';
  els.hOrgName.value = p?.host?.orgName || '';
  els.hIdType.value = p?.host?.idType || '';
  els.hIdName.value = p?.host?.idName || '';
  els.hIdImage.value = '';
  renderProfileSummary(p);
}
function renderProfileSummary(p){
  const status = p?.isHost ? (p?.host?.verified ? '✅ Host verified (local)' : '⚠️ Host not verified') : '—';
  els.profileSummary.innerHTML = `
    <div style="margin-top:6px;display:flex;gap:10px;flex-wrap:wrap">
      <span class="pill">Name: ${p?.name || '-'}</span>
      <span class="pill">Email: ${p?.email || '-'}</span>
      <span class="pill">City: ${p?.city || '-'}</span>
      <span class="pill">Host: ${p?.isHost ? 'Yes' : 'No'}</span>
      ${p?.isHost ? `<span class="pill">Status: ${status}</span>` : ''}
    </div>
    <p class="small" style="margin-top:8px">Note: This is a local demo; real verification needs a backend.</p>
  `;
}

/* Profile dialog open/close */
els.avatarBtn.addEventListener('click', ()=>{
  const p = readProfile();
  fillProfileForm(p);
  els.profileDialog.showModal();
});
els.cancelProfile.addEventListener('click', ()=>{
  // simply close without saving
  els.profileDialog.close();
});

/* Host toggle fields */
els.pIsHost.addEventListener('change', (e)=>{
  els.hostFields.style.display = (e.target.value === 'yes') ? 'block' : 'none';
});

/* Save profile (with host verification) */
els.saveProfileBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  const name = els.pName.value.trim();
  const email = els.pEmail.value.trim();
  if (!name || !email){ alert('Please enter your name and email.'); return; }

  const prev = readProfile();
  let photoDataUrl = prev?.photo || '';
  const photoFile = els.pPhoto.files[0];
  if (photoFile){ photoDataUrl = await fileToDataURL(photoFile); }

  const isHost = (els.pIsHost.value === 'yes');
  let host = null, verified = false;
  if (isHost){
    const orgName = els.hOrgName.value.trim();
    const idType = els.hIdType.value;
    const idName = els.hIdName.value.trim();
    const idImgFile = els.hIdImage.files[0];

    if (!orgName || !idType || !idName){ alert('Complete all host fields.'); return; }
    if (!idImgFile){ alert('Upload an ID image.'); return; }
    if (idName !== name){ alert('Name on ID must exactly match your profile Full Name.'); return; }

    const idImage = await fileToDataURL(idImgFile);
    verified = !!idImage && (idName === name);
    host = { orgName, idType, idName, idImage, verified };
  }

  const profile = { name, email,
    phone: els.pPhone.value.trim(),
    city: els.pCity.value.trim(),
    photo: photoDataUrl, isHost, host
  };
  writeProfile(profile);
  setAvatarFromProfile(profile);
  renderProfileSummary(profile);
  els.profileDialog.close();
});

/* Host dashboard access */
els.hostBtn.addEventListener('click', ()=>{
  const p = readProfile();
  if (!(p?.isHost && p?.host?.verified)) {
    alert('You must be a verified host to post events.');
    return;
  }
  els.hostDialog.showModal();
});

/* Save Event (Host Dashboard) */
els.saveEventBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  const p = readProfile();
  if (!(p?.isHost && p?.host?.verified)){
    alert('Only verified hosts can post events.');
    return;
  }

  const title = els.fTitle.value.trim();
  const category = els.fCategory.value.trim();
  const locationCity = els.fLocation.value.trim();
  const venue = els.fVenue.value.trim();
  const start = els.fStart.value;
  const end = els.fEnd.value;
  const price = Number(els.fPrice.value || 0);
  if(!title || !category || !locationCity || !venue || !start || !end){
    alert('Please fill in all required fields.'); return;
  }
  if (new Date(end) < new Date(start)){ alert('End must be after start.'); return; }

  const coverDataUrl = await fileToDataURL(els.fCover.files[0]);

  const newEvent = {
    id: uid(), title, category,
    location: locationCity, venue,
    startsAt: new Date(start).toISOString(),
    endsAt: new Date(end).toISOString(),
    priceJMD: price, description: els.fDesc.value || '',
    cover: coverDataUrl,
    hostId: p.email || p.name
  };
  const all = readDB(); all.push(newEvent); writeDB(all);
  els.hostDialog.close();
  applyFilters();
  alert('Event posted.');
});

/* ===== Boot ===== */
if (readDB().length === 0) writeDB([]); // keep empty by default
refreshFilterOptions(readDB());
applyFilters();

const prof = readProfile();
if (prof) setAvatarFromProfile(prof);
</script>
</body>
</html>
